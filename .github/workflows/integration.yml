name: Integration checks and automation

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read
  packages: write

env:
  UV_VERSION: "0.9.6"
  FETCH_DEPTH: 0

jobs:
  python_quality_and_build:
    name: Python Quality Checks and Build
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5.0.0
        with:
          fetch-depth: ${{ env.FETCH_DEPTH }}

      - name: Install uv
        uses: astral-sh/setup-uv@85856786d1ce8acfbcc2f13a5f3fbd6b938f9f41 #v7.1.2
        with:
          version: ${{ env.UV_VERSION }}

      - name: Install dependencies
        run: uv sync --dev

      - name: Run pre-commit
        run: uv run pre-commit run --all-files

      - name: Run tests
        run: uv run pytest

      - name: Build package
        run: uv build

      - name: Upload build artifacts
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 #v5.0.0
        with:
          name: dist
          path: dist/
          retention-days: 7

  build_docker:
    name: Build Docker Container
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: python_quality_and_build

    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5.0.0
        with:
          fetch-depth: ${{ env.FETCH_DEPTH }}

      - name: Generate Docker image tag
        id: generate-tag
        shell: bash
        run: |
          ghcr_path=ghcr.io/${GITHUB_REPOSITORY_OWNER,,}/lenzr-server

          case "${{ github.event_name }}-${{ github.ref_type }}-${{ github.ref_name }}" in
            push-tag-*)
              # Tags: push with tag name + latest
              tag="${{ github.ref_name }}"
              echo "image_tags=${ghcr_path}:${tag},${ghcr_path}:latest" >> $GITHUB_OUTPUT
              echo "push=true" >> $GITHUB_OUTPUT
              ;;
            push-branch-main)
              # Main branch: push with dated tag + latest
              tag="main-$(date +%Y%m%d)-${GITHUB_SHA::7}"
              echo "image_tags=${ghcr_path}:${tag},${ghcr_path}:main" >> $GITHUB_OUTPUT
              echo "push=true" >> $GITHUB_OUTPUT
              ;;
            pull_request-*)
              # PRs: local build only
              echo "image_tags=lenzr-server:pr-${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
              echo "push=false" >> $GITHUB_OUTPUT
              ;;
            *)
              # Manual/other: local build only
              echo "image_tags=lenzr-server:manual" >> $GITHUB_OUTPUT
              echo "push=false" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Setup Docker buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 #v3.11.1

      - name: Login to GitHub Container Registry
        if: ${{ steps.generate-tag.outputs.push }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 #v6.18.0
        with:
          context: .
          push: ${{ steps.generate-tag.outputs.push }}
          tags: ${{ steps.generate-tag.outputs.image_tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
